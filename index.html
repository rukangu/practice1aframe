<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR/VR Physics Classroom</title>

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

  <script>
    AFRAME.registerComponent('physics-grab', {
      init() {
        this.grabbedEl = null;
        this.prevPos = new THREE.Vector3();
        this.currPos = new THREE.Vector3();

        this.el.addEventListener('grab-start', e => {
          const target = e.detail.target;
          if (!target || !target.classList.contains('grabbable')) return;

          this.grabbedEl = target;

          if (target.body) {
            target.body.type = CANNON.Body.KINEMATIC;
            target.body.velocity.set(0, 0, 0);
            target.body.angularVelocity.set(0, 0, 0);
          }

          target.object3D.position.set(0, 0, 0);
          this.el.object3D.attach(target.object3D);
        });

        this.el.addEventListener('grab-end', () => {
          if (!this.grabbedEl) return;

          this.el.sceneEl.object3D.attach(this.grabbedEl.object3D);

          if (this.grabbedEl.body) {
            this.grabbedEl.body.type = CANNON.Body.DYNAMIC;
            const throwVel = this.currPos.clone()
              .sub(this.prevPos)
              .multiplyScalar(200);
            this.grabbedEl.body.velocity.copy(throwVel);
          }

          this.grabbedEl = null;
        });
      },

      tick() {
        this.prevPos.copy(this.currPos);
        this.el.object3D.getWorldPosition(this.currPos);
      }
    });
  </script>
</head>

<body>
<a-scene physics="gravity: -9.8">

  <a-assets>
    <img id="ubuntu" src="https://upload.wikimedia.org/wikipedia/commons/a/a3/Ubuntu_logo_and_wordmark.svg">
    <a-asset-item id="duck" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb"></a-asset-item>
  </a-assets>

  <a-entity environment="preset: forest"></a-entity>

  <a-box static-body rotation="-90 0 0" width="50" height="50" depth="0.1"></a-box>

  <a-box class="grabbable"
         dynamic-body
         position="0 1.5 -0.6"
         width="0.6" height="0.4" depth="0.05"
         material="src:#ubuntu">
  </a-box>

  <a-entity class="grabbable"
            dynamic-body
            gltf-model="#duck"
            position="0.4 1.6 -0.5"
            scale="0.5 0.5 0.5">
  </a-entity>

  <a-entity camera position="0 1.6 0"></a-entity>

  <!-- Hands -->
  <a-entity hand-tracking-controls="hand: left" physics-grab></a-entity>
  <a-entity hand-tracking-controls="hand: right" physics-grab></a-entity>

  <!-- Controllers -->
  <a-entity laser-controls="hand: left"
            raycaster="objects: .grabbable"
            grab-controls
            physics-grab></a-entity>

  <a-entity laser-controls="hand: right"
            raycaster="objects: .grabbable"
            grab-controls
            physics-grab></a-entity>

</a-scene>
</body>
</html>
