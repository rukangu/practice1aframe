<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Classroom AR/VR Setup</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

    <script>
      /* * CUSTOM COMPONENT: CONTROLLER GRAB
       * This forces the laser pointer to "stick" to objects when the trigger is held.
       */
      AFRAME.registerComponent('controller-grab', {
        init: function () {
          this.grabbedEl = null;
          this.raycaster = this.el.components.raycaster;

          this.el.addEventListener('triggerdown', (evt) => {
            // 1. Get the raycaster component attached to this controller
            const raycaster = this.el.components.raycaster;
            if (!raycaster) return;

            // 2. Find closest intersection with ".grabbable" objects
            // We specifically ask for the list of intersected objects
            const intersections = raycaster.intersectedEls;
            
            if (intersections.length > 0) {
              // The first item is the closest one
              const objectToGrab = intersections[0];
              
              // 3. Double check it has the class we want
              if (objectToGrab.classList.contains('grabbable')) {
                this.grabbedEl = objectToGrab;
                
                // 4. Attach object to controller (this makes it follow you)
                this.grabbedEl.object3D.attach(this.el.object3D);
              }
            }
          });

          this.el.addEventListener('triggerup', (evt) => {
            if (this.grabbedEl) {
              // 5. Unparent (put it back in the world)
              this.el.sceneEl.object3D.attach(this.grabbedEl.object3D);
              this.grabbedEl = null;
            }
          });
        }
      });
    </script>
  </head>

  <body>
    <a-scene 
      xr-mode-ui="XRMode: xr" 
      webxr="optionalFeatures: hit-test"
      renderer="colorManagement: true; exposure: 1; toneMapping: ACESFilmic"
      shadow="type: pcfsoft">

      <a-assets>
        <img id="ubuntu-img" src="https://cdn.jsdelivr.net/gh/aframevr/aframe@master/examples/showcase/hand-tracking/images/ubuntu-desktop.png" crossorigin="anonymous">
        <a-asset-item id="my-model" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb"></a-asset-item>
      </a-assets>

      <a-entity environment="preset: forest; lighting: none; shadow: true" hide-on-enter-ar></a-entity>
      
      <a-light type="directional" intensity="1" position="-1 2 2" cast-shadow="true"></a-light>
      <a-light type="ambient" intensity="0.6"></a-light>


      <a-entity position="-0.5 1.6 -0.5" class="grabbable" grabbable>
         <a-box depth="0.02" height="0.6" width="1" material="src: #ubuntu-img" color="white"></a-box>
      </a-entity>

      <a-entity 
        gltf-model="#my-model" 
        position="0.5 1.6 -0.5" 
        scale="0.5 0.5 0.5" 
        class="grabbable" 
        grabbable>
      </a-entity>


      <a-entity camera position="0 1.6 0" look-controls wasd-controls></a-entity>

      <a-entity id="rightHand" hand-tracking-grab-controls="hand: right"></a-entity>
      <a-entity id="leftHand" hand-tracking-grab-controls="hand: left"></a-entity>

      <a-entity id="rightControl" 
                laser-controls="hand: right" 
                raycaster="objects: .grabbable; far: 5"
                controller-grab>
      </a-entity>
      <a-entity id="leftControl" 
                laser-controls="hand: left" 
                raycaster="objects: .grabbable; far: 5"
                controller-grab>
      </a-entity>

    </a-scene>
  </body>
</html>